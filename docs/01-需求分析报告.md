# 需求分析报告

项目名称：赤峰市安定医院信息化建设项目 — AI 辅助诊断系统

版本：1.0

编写人：北京远谋科技有限公司 交付组

日期：2025-11-30

说明：本需求分析报告严格依据合同`合同.md`、技术要求`技术要求.md`及投标响应`技术响应表.md`中的条款编写，结合乙方已完成的技术实现文档（`chifeng-ai-diagnosis_wiki.md`、`kotaemon_wiki.md`、`parse_data_wiki.md`）整理而成。文中描述以可验证、可交付的内容为限，避免任何未经证明的夸大或推测。

## 1. 封面与修订记录

1.1 封面已列于文首。

1.2 修订记录

| 版本 | 日期 | 作者 | 说明 |
|---:|---|---|---|
| 1.0 | 2025-11-30 | 交付组 | 初版，基于合同、技术要求与已交付wiki内容编写 |

## 2. 术语与缩写

为保证文档一致性，列出关键术语与缩写：

- AI: 人工智能（Artificial Intelligence）。
- LLM: 大型语言模型（Large Language Model）。
- RAG: 检索增强生成（Retrieval-Augmented Generation）。
- TTFT: 单次生成响应时间（Time To First Token/Time To First Text），用于衡量模型响应延迟。文中以技术响应表中定义为准。 
- MRR: 平均倒数排名（Mean Reciprocal Rank），用于检索质量评估。
- Recall@N: 检索召回率，表示在前 N 条中包含相关片段的比例。
- K/N: 检索召回数量/最终上下文数量。K 表示初步召回片段数，N 表示重排行后作为输入的大模型上下文片段数。

## 3. 项目概述（背景、目标、范围）

3.1 背景

赤峰市安定医院推进信息化建设，需求包含基于病案数据的智能医疗分析与辅助诊断功能。甲方通过招标确定乙方按合同提供软件系统与相关服务，合同与技术要求明确了功能、性能、安全与验收标准。为实现医院临床与科研需求，系统需集成数据解析、向量化检索、重排序与大型语言模型推理等模块，生成可追溯的医疗分析报告，辅助医生诊断决策并为科研提供数据支持。

3.2 目标

本项目的主要目标为交付一套可在医院环境中部署的AI辅助诊断系统，满足合同与技术要求中规定的功能与非功能指标，包含但不限于：病例数据录入、结构化数据解析、向量化与检索模块、重排序模块、RAG 引擎、模型推理接口（OpenAI 兼容 RESTful API）、Web 前端展示与可追溯的报告生成，以及运维监控与安全合规措施。

3.3 范围

系统范围覆盖：数据预处理（CSV/JSON/PDF 的标准化）、嵌入与向量索引、基于检索的问答与报告生成功能、前端展示与溯源、部署脚本与容器化支持、监控与告警、以及文档与培训支持。医疗影像、脑电等大型二进制数据的深度解析如需额外插件，属于后续扩展范围（合同内对影像类数据以附件说明为准）。

## 4. 业务流程描述

4.1 总体业务流程

系统的总体业务流程从医院端数据上传（病案首页、检验/检查、医嘱等结构化数据和相关PDF附件）开始，经数据标准化与融合后进入向量化与检索模块。检索出的候选病例片段（K）经过重排序模块精排，筛选出最终上下文片段（N）作为大模型的上下文输入，模型生成辅助诊断建议与分析报告，前端提供可追溯原始片段和相似度，以支撑临床决策和科研分析。

以下 mermaid 图为关键业务流程示意：

```mermaid
graph TD
  U[用户上传数据] --> P[数据解析与标准化]
  P --> E[嵌入与向量索引]
  E --> R[初步检索 (K)]
  R --> S[重排序 (Rerank)]
  S --> N[筛选最终上下文 (N)]
  N --> M[LLM 推理与报告生成]
  M --> V[前端展示与溯源]
  V --> U
```

4.2 用例列表与说明

用例 1：病例上传与解析 — 医护或科研人员上传病例数据（CSV/JSON/PDF），系统自动解析并返回解析结果与问题提示。输入为上传文件与元数据，处理包括文件解析、字段映射与校验，输出为结构化 JSON 与解析日志；边界条件包括字段缺失或格式异常，系统应返回明确错误并记录在日志中。

用例 2：相似病例检索 — 用户在界面输入查询（自然语言或症状/诊断代码），系统执行嵌入与检索返回候选片段，并支持点击溯源查看原始片段；处理链路包括文本预处理、查询嵌入、向量数据库检索、重排序与结果呈现；输出为带相似度评分的候选列表，边界条件包括查询太短或无关信息，系统应提示并建议补充上下文。

用例 3：辅助诊断报告生成 — 系统根据选定上下文与模型配置生成结构化医疗分析报告，报告内容包括病例摘要、诊疗过程、检验结果分析与结论；处理涉及 prompt 模板加载、上下文拼接、调用 LLM 并对输出进行结构化解析与合规检查（敏感内容过滤）。输出为 PDF/文本报告并记录生成来源；边界条件包括上下文过长需截断或分页处理，系统需保证关键证据被保留并在报告中标注来源片段。

## 5. 功能需求

5.1 用例/功能清单（编号）

- FR-01 病例数据上传（CSV/JSON/PDF）
- FR-02 自动化数据解析与标准化
- FR-03 批量导入与处理（≥10 条样本批量导入≤3 分钟的性能目标）
- FR-04 文本嵌入与向量索引构建
- FR-05 文本检索与初步召回（K 可配置，默认≥10）
- FR-06 重排序（Rerank）模块
- FR-07 RAG 引擎与上下文拼接（N 可配置，默认≤5）
- FR-08 模型推理服务（OpenAI 兼容 RESTful API）
- FR-09 前端展示与结果溯源（点击查看来源片段）
- FR-10 系统监控与告警（召回率、MRR、推理延迟等指标）
- FR-11 双网卡部署与离线部署支持
- FR-12 权限管理与审计日志
- FR-13 运维、备份与恢复功能

5.2 每项功能的详细说明：输入、处理、输出、边界条件

FR-01 病例数据上传（CSV/JSON/PDF）

输入：用户上传的文件或文件包，包含病案首页、检验/检查、医嘱等。系统应支持常见Excel/CSV、结构化JSON与PDF附件。

处理：文件接收后进行校验（文件名、病案号匹配）、预处理（字符编码、空白行清理）、格式识别与分流到相应解析器（CSV 转 JSON、PDF OCR/元数据提取）。处理过程需对异常（缺字段、格式不符）进行记录并回传错误信息。

输出：标准化后的 JSON 病例记录，包含字段映射表与解析日志；对于失败的文件，输出错误报告并建议修正方案。

边界条件：上传文件过大、字段缺失或 OCR 失败时系统应中止该文件处理并写入错误，同时保证其他文件继续处理。

FR-02 自动化数据解析与标准化

输入：来自 FR-01 的原始文件或 JSON 数据。

处理：依据配置文件（如 `conf/headers.json`、`prompt.txt`）执行字段映射、时间格式统一、ICD 编码校验、空值填充及数据一致性检查。

输出：结构化 JSON、解析报告与校验日志。

边界条件：编码不一致或字段命名差异通过映射表处理；若映射失败记录在错误日志以便人工介入。

FR-03 批量导入与处理

输入：批量文件包或批量 JSON 列表（示例：10 条医学样本）。

处理：并行化解析与入库流程，采用批量写入与事务设计保证数据完整性；同时记录时间戳以便性能评估。

输出：批量导入报告（记录每条样本的处理耗时、成功/失败状态）。

边界条件：若导入超过资源阈值，系统需自动降级并提示迁移到离线导入流程。

5.3 非功能性需求（性能、并发、可用性、安全、兼容性）

本节严格依据 `技术要求.md` 与 `技术响应表.md` 中的约定，详细列出系统的非功能性需求，并为每项提供验证方法与合规性要求。以下内容为必须满足并在验收时验证的关键指标与行为描述。

性能与响应时间要求：系统在招标文件指定硬件环境下，单次模型生成建议的平均响应时间（TTFT）需小于 5 秒。投标响应中声明在指定硬件上通过优化推理框架（如 vLLM / LMStudio）实现的平均 TTFT 为 3.8 秒，验收时需在甲方或指定的验收环境内复现该指标。为了确保该性能指标，系统需具备以下能力：模型加载与热启动机制、请求队列与优先级调度、显存与内存优化策略、以及多路并发请求的资源隔离。验证方法包括在目标硬件上执行标准化负载脚本，并记录 95/99 百分位响应时间与平均值；性能报告需包含环境配置、测试脚本、原始日志与统计汇总。

并发与吞吐：系统应支持至少 10 路并发用户请求在指定硬件下稳定运行，且响应无显著阻塞或错误。投标响应中已测试支持 12 路并发，验收时需执行并发压力测试（并发数从 1 至 20 递增）以确定系统的最大稳定并发能力，并记录吞吐、CPU/GPU 利用率、内存与网络带宽占用。系统需提供并发控制机制（如连接池、令牌桶等）以防止资源枯竭。

稳定性与可用性：系统需保证 99.9% 以上的可用性。投标响应在 30 天稳定性测试中给出 99.925% 的数据，验收需要提供 72 小时满负荷运行日志、服务重启记录与错误级别日志（无 ERROR 级别）。系统需设计自动重试、健康检查与备用服务（若采用多实例部署）以支持高可用架构。

数据解析准确率：对 10 条医学样本数据（含结构化病例数据、影像数据、脑电数据等若适用）的批量导入与解析，系统需在 3 分钟内完成并保证解析准确率≥99.9%。数据解析准确率定义为关键字段（病案号、主诊断、住院号、重要检验值等）与人工对照的一致性百分比。验收时需使用由甲方提供或双方一致认可的样本数据集进行抽样校验与对比。

模型与检索质量：系统的向量化与检索模块需使用高质量嵌入模型（如 Qwen3-Embedding-8B 或同等性能），并支持至少 32K Token 的长文本编码（投标响应声称支持 35K Token）；检索与重排组合需在内部测试集上达到 Recall@5 ≥ 85%（投标响应给出 Recall@5 = 88.2%）且重排序显著提升 TOP 结果的信噪比。验收测试需包含标准化的检索测试集、评价指标脚本与结果报告。

接口与兼容性：系统需提供 OpenAI 兼容 RESTful API 接口以便集成，支持 Docker 容器化部署，并兼容常见客户端浏览器（Chrome 90+、Edge 90+）与操作系统（Windows10/11、macOS12+）。验收需通过 API 调用验证接口的一致性、认证与超时处理逻辑，并在目标浏览器上进行基本兼容性检查。

安全与合规性：系统必须对患者隐私数据进行加密存储与传输，满足《中华人民共和国个人信息保护法》和 GB/T39725-2020 的要求。系统需实现三级用户权限控制，提供审计日志功能，并支持双网卡物理隔离部署方案以满足医院 IT 合规性要求。验收需审查加密算法与密钥管理策略、权限矩阵、审计日志样例与合规审核材料。

监控与预警：系统需提供可视化监控面板，实时监控召回率（Recall）、MRR、推理延迟、知识库更新延迟与向量库查询耗时等关键指标，并实现基于动态阈值的预警机制（邮件、短信、系统弹窗）。验收将检查监控面板配置、历史趋势导出与告警触发记录。

兼容性与部署：系统需支持离线部署（通过 U 盘/FTP 分发安装包），并附带完整的离线部署手册与运维脚本。验证方法包括执行离线部署流程并核验安装成功、服务自启动和基本功能可用性。

性能验证与验收输出要求：所有非功能性指标需通过可复现的测试脚本与日志证明，验收包应包含性能测试脚本、原始日志、统计汇总、环境说明（硬件/软件配置）以及测试数据集或其获取说明。

（注：以上非功能性需求条款在验收中须与 `技术响应表.md` 中的实际承诺数值一一比对并复现。）

## 6. 数据需求（主要数据项、数据字典概览）

6.1 数据概述

系统处理的数据来源包括病案首页、检验/检查结果、医嘱信息、影像或附件文件（PDF）等。为保证报告生成与检索的准确性，需识别并标准化以下核心字段：病案号、住院号、姓名（脱敏处理）、年龄、性别、入院/出院时间、主诊断、主要手术、检验项目与数值、检查结论、用药记录与医嘱等。

6.2 数据字典（示例）

- case_id: 病案号，字符串，6 位或更多（左补 0）
- patient_id: 住院号，字符串
- admission_date: 入院日期，ISO 格式 YYYY-MM-DD
- discharge_date: 出院日期，ISO 格式
- main_diagnosis: 主诊断，标准 ICD-10 编码与文本
- lab_results: 检验项列表（名称、数值、单位、参考区间、检验时间）
- imaging_reports: 检查报告文本或 PDF 附件元数据

（完整数据字典应在附录中提供机器可读的 JSON/CSV 文件）

## 7. 接口需求（外部系统、API、文件格式）

7.1 API 概述

系统需提供 OpenAI 兼容的 RESTful API，以便外部系统调用模型推理与检索服务。API 应支持身份认证（Token/密钥）、请求速率限制、返回标准化 JSON 结构与错误码规范。

7.2 主要接口示例

- POST /api/v1/upload: 文件上传接口，参数：file、metadata
- POST /api/v1/parse: 触发对指定文件或 record 的解析
- POST /api/v1/search: 文本或症状查询，参数：query、top_k
- POST /api/v1/generate: 以已选上下文生成报告，参数：context_ids、model_name、temperature

7.3 文件与数据格式

系统需支持 CSV、JSON 和 PDF 格式的输入，JSON 格式需满足 predefined schema（详见附录 schema 文件）。输出报告可导出为 JSON、TXT、PDF。

## 8. 业务规则与权限控制

8.1 业务规则

- 证据可追溯性规则：系统生成的每条诊断建议须标注至少一个来源病例片段（相似度评分与片段位置），且在展示时需隐藏个人隐私信息。
- 报告合规规则：系统生成结论时禁止超出可证实范围的诊断性断言，所有推断须以数据或历史病例片段为依据并在报告中注明参考来源。

8.2 权限控制

系统应实现三级权限：管理员（系统配置、用户管理）、医生/科研用户（数据查询、报告生成、病例溯源）、只读用户（查看报告与检索结果但不可导出敏感数据）。权限变更与重要操作应记录审计日志（含操作者、时间、操作内容）。

## 9. 可追溯性矩阵（需求→用例→测试用例）

本节提供需求项到用例及测试用例的映射示例（完整矩阵见附录可下载表格）。

示例：

- 需求 FR-05（文本检索） → 用例 UC-02（相似病例检索） → 测试用例 TC-102（检索返回 Top-5 中包含已知相关片段的比例≥85%）。

## 10. 验收标准与验收测试计划

10.1 验收总体原则

验收以合同与技术要求为准，所有功能性需求须通过逐条功能验证；非功能性需求需提供可复现的测试脚本与原始日志证明。甲方验收由甲方代表、乙方代表及技术评审小组参与，验收结果以书面形式记录。

10.2 关键验收指标

- 功能完整性：100% 覆盖附件一列举的功能；
- 性能：TTFT ≤ 5s（目标）、并发 ≥ 10 路；
- 数据解析：批量导入 10 条样本 ≤ 3 分钟，解析准确率 ≥ 99.9%；
- 可用性：≥ 99.9%；
- 合规：加密、权限与审计满足相关法规与标准；
- 文档：交付安装包、源代码、测试报告（含 500 条用例）与用户操作手册等。

10.3 验收测试计划（建议步骤）

1) 交付清单核对：乙方提交验收包并确认清单；
2) 部署与环境准备：在甲方或双方约定环境完成部署；
3) 功能测试：按功能清单逐项执行并记录结果；
4) 性能与并发测试：在目标硬件上复现 TTFT 与并发测试；
5) 稳定性测试：执行 72 小时满负荷运行并收集日志；
6) 合规检查：审查加密、权限与审计日志样例；
7) 最终演示与签署验收单。

## 11. 风险分析与缓解措施

11.1 风险项

- R1 硬件资源不足导致模型推理性能不达标；
- R2 数据质量不一致导致解析准确率下降；
- R3 合规性审核延迟或对加密/权限要求更高；
- R4 依赖第三方模型或服务不可用或变更接口；
- R5 现场部署与集成环境差异引发运行异常。

11.2 缓解措施

- 对 R1：提供硬件参考配置与性能基准，支持通过容器化快速迁移到更高性能节点；
- 对 R2：提供详尽的数据校验与清洗规则、并支持手动校正流程；
- 对 R3：提前提交合规材料、密钥管理与审计方案并与甲方IT/伦理委员会沟通；
- 对 R4：支持模型本地化部署或替代模型配置，并提供回退策略；
- 对 R5：提供标准化部署脚本、离线部署手册与现场支持计划（合同要求现场服务≥14 天）。

## 12. 附件（样例病历、数据样本、相关合同节选）

附件应包含：样例 JSON/CSV 数据（至少 10 条供验收使用）、示例 PDF 报告、`conf/llm.json` 与 `conf/prompt.txt` 的配置摘录、合同中有关验收、付款与售后条款的相关节选。

---
提交人：北京远谋科技有限公司 交付组

日期：2025-11-30
